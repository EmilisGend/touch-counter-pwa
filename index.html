<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Touch & Click Counter — Night</title>
  <meta name="theme-color" content="#021026"/>
  <link rel="manifest" href="./manifest.json">
  <style>
    :root{
      --bg:#020317;
      --card:#071026;
      --accent:#06b6d4;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:var(--bg); color:#e6eef8;}
    /* Fullscreen canvas background */
    canvas#stars{ position:fixed; inset:0; width:100%; height:100%; z-index:0; display:block; }
    main.app{ position:relative; z-index:2; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; box-sizing:border-box;}
    .card{ width:100%; max-width:520px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:18px; padding:28px; box-shadow:0 10px 30px rgba(2,6,23,0.6); text-align:center; backdrop-filter: blur(6px); }
    h1{ margin:0 0 8px 0; font-size:20px}
    p.lead{ margin:0 0 18px 0; color:var(--muted); font-size:13px}
    .count{ font-size:88px; font-weight:800; margin:6px 0; letter-spacing:-4px; color:transparent; -webkit-text-stroke:1px rgba(230,238,248,0.85); text-shadow: 0 6px 30px rgba(6,182,212,0.06);}
    /* Center big button */
    .center-wrap{ display:flex; align-items:center; justify-content:center; gap:12px; flex-direction:column; }
    button#tapBtn{ width:220px; height:220px; border-radius:50%; border:0; font-size:20px; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 8px 30px rgba(6,182,212,0.12); user-select:none; background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.06), rgba(255,255,255,0.02)), linear-gradient(180deg, rgba(6,182,212,0.14), rgba(124,58,237,0.08)); color:#e6eef8; transform:translateY(0); transition:transform 120ms ease, box-shadow 120ms ease;}
    button#tapBtn:active{ transform:translateY(4px) scale(0.995); box-shadow:0 4px 20px rgba(6,182,212,0.08); }
    .small-btns{ display:flex; gap:8px; margin-top:14px; justify-content:center; flex-wrap:wrap;}
    .tiny{ padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--muted); cursor:pointer;}
    footer{ margin-top:14px; color:var(--muted); font-size:13px; }
    /* Install button */
    #installBtn{ display:none; }
    /* Responsive */
    @media (max-width:420px){ .count{ font-size:56px } button#tapBtn{ width:180px; height:180px } }
  </style>
</head>
<body>
  <canvas id="stars" aria-hidden="true"></canvas>

  <main class="app" role="application" aria-labelledby="app-title">
    <div class="card" role="region" aria-live="polite" aria-label="Night counter card">
      <h1 id="app-title">Touch & Click Counter — Night</h1>
      <p class="lead">Tap the orb. Works on mobile & desktop. Falling stars wallpaper — downloadable snapshot below.</p>

      <div class="center-wrap">
        <div class="count" id="count">0</div>
        <button id="tapBtn" aria-pressed="false" aria-label="Tap to increment">Tap</button>

        <div class="small-btns" role="toolbar" aria-label="controls">
          <button id="decBtn" class="tiny">- Decrement</button>
          <button id="resetBtn" class="tiny">Reset</button>
          <button id="snapshotBtn" class="tiny">Save Snapshot</button>
          <button id="downloadBtn" class="tiny">Download Image</button>
          <button id="installBtn" class="tiny">Install</button>
        </div>
      </div>

      <footer>Stored locally • <span id="storageLabel">localStorage</span></footer>
    </div>
  </main>

  <script>
  // Simple counter logic + storage
  const countEl = document.getElementById('count');
  const tapBtn = document.getElementById('tapBtn');
  const decBtn = document.getElementById('decBtn');
  const resetBtn = document.getElementById('resetBtn');
  const snapshotBtn = document.getElementById('snapshotBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const installBtn = document.getElementById('installBtn');
  const KEY = 'touch-counter-night-v1';
  let count = Number(localStorage.getItem(KEY) || 0);
  let deferredPrompt = null;
  function render(){ countEl.textContent = count; }
  render();

  tapBtn.addEventListener('pointerdown', () => { count++; render(); });
  decBtn.addEventListener('click', ()=>{ count = Math.max(0, count-1); render(); localStorage.setItem(KEY, String(count)); });
  resetBtn.addEventListener('click', ()=>{ count = 0; render(); localStorage.setItem(KEY, String(count)); });
  snapshotBtn.addEventListener('click', ()=> {
    const histKey = 'touch-counter-night-history-v1';
    const history = JSON.parse(localStorage.getItem(histKey) || '[]');
    history.push({count, at:new Date().toISOString()});
    localStorage.setItem(histKey, JSON.stringify(history));
    flash('Snapshot saved');
  });

  function flash(msg){
    const el = document.createElement('div');
    el.textContent = msg;
    Object.assign(el.style, {position:'fixed', left:'50%', transform:'translateX(-50%)', bottom:'28px', padding:'8px 12px', background:'#021026', color:'#e6eef8', borderRadius:'8px', boxShadow:'0 6px 18px rgba(2,6,23,0.6)', zIndex:9999});
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 1400);
  }

  // download image: render current view (canvas stars + main card) into PNG
  downloadBtn.addEventListener('click', async ()=> {
    try{
      const canvasStars = document.getElementById('stars');
      // draw stars canvas and card onto a new canvas
      const w = Math.min(window.innerWidth, 1080);
      const h = Math.min(window.innerHeight, 1920);
      const out = document.createElement('canvas');
      out.width = w; out.height = h;
      const ctx = out.getContext('2d');

      // draw stars
      ctx.drawImage(canvasStars, 0, 0, w, h);

      // draw a snapshot of the card using foreignObject via SVG
      const card = document.querySelector('.card');
      const style = getComputedStyle(card);
      const html = `<div xmlns='http://www.w3.org/1999/xhtml' style='font-family: ${style.fontFamily}; color: ${style.color}; width:${Math.floor(w*0.85)}px; background: ${style.background}; border-radius:18px; padding:18px; box-sizing:border-box;'>
        <h1 style='margin:0;font-size:20px'>Touch & Click Counter — Night</h1>
        <div style='font-size:72px;font-weight:800;margin-top:8px'>${count}</div>
      </div>`;
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><foreignObject x='${Math.floor(w*0.075)}' y='${Math.floor(h*0.2)}' width='${Math.floor(w*0.85)}' height='${Math.floor(h*0.4)}'>${html}</foreignObject></svg>`;
      const blob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = ()=> {
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);
        out.toBlob((b)=>{
          const a = document.createElement('a');
          a.href = URL.createObjectURL(b);
          a.download = `touch-counter-${Date.now()}.png`;
          document.body.appendChild(a); a.click(); a.remove();
        });
      };
      img.src = url;
    }catch(err){
      console.error(err);
      flash('Download failed');
    }
  });

  // beforeinstallprompt
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-block';
  });
  installBtn.addEventListener('click', async ()=>{
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    if(choice.outcome === 'accepted') flash('Installed');
    deferredPrompt = null; installBtn.style.display='none';
  });

  // register service worker
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').then(()=> console.log('sw registered')).catch(()=>console.warn('sw fail'));
  }

  // persist periodically
  setInterval(()=> localStorage.setItem(KEY, String(count)), 2000);

  // keyboard support
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'Space' || e.code === 'Enter'){ e.preventDefault(); count++; render(); }
  });
  </script>

  <script>
  // falling stars animation on canvas
  const canvas = document.getElementById('stars');
  const ctx = canvas.getContext('2d');
  let DPR = Math.max(1, window.devicePixelRatio || 1);
  function resize(){ canvas.width = Math.floor(window.innerWidth * DPR); canvas.height = Math.floor(window.innerHeight * DPR); canvas.style.width = window.innerWidth + 'px'; canvas.style.height = window.innerHeight + 'px'; }
  window.addEventListener('resize', resize);
  resize();

  // create static twinkling stars + falling meteors
  const stars = [];
  const shooting = [];
  function rand(min,max){ return Math.random()*(max-min)+min; }

  // static background stars
  for(let i=0;i<200;i++){
    stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r: rand(0.3,1.2), alpha:rand(0.2,0.9), tw: Math.random()*1.5});
  }

  // shooting generation
  function spawnShooting(){
    const startY = Math.random()*canvas.height*0.4;
    shooting.push({
      x: Math.random()*canvas.width,
      y: startY,
      vx: rand(-4,-1.5) * DPR,
      vy: rand(4,8) * DPR,
      life: rand(500,1200),
      age:0,
      length: rand(80,220)
    });
  }

  setInterval(()=>{ if(Math.random()<0.45) spawnShooting(); }, 900);

  let last = performance.now();
  function frame(t){
    const dt = t - last; last = t;
    // clear with gradient
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0, '#001022'); g.addColorStop(1, '#00000c');
    ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);

    // draw static stars
    for(const s of stars){
      s.alpha += Math.sin(t/1000 + s.tw) * 0.002;
      ctx.beginPath();
      ctx.fillStyle = `rgba(255,255,255,${Math.max(0, Math.min(1, s.alpha))})`;
      ctx.arc(s.x, s.y, s.r*DPR, 0, Math.PI*2);
      ctx.fill();
    }

    // draw shooting stars
    for(let i=shooting.length-1;i>=0;i--){
      const m = shooting[i];
      m.age += dt;
      m.x += m.vx * dt/16.67; m.y += m.vy * dt/16.67;
      const prog = m.age / m.life;
      ctx.beginPath();
      const grad = ctx.createLinearGradient(m.x, m.y, m.x - m.vx*m.length, m.y - m.vy*m.length);
      grad.addColorStop(0, 'rgba(255,255,255,1)');
      grad.addColorStop(1, 'rgba(6,182,212,0.08)');
      ctx.strokeStyle = grad;
      ctx.lineWidth = 1.5 * DPR;
      ctx.moveTo(m.x, m.y);
      ctx.lineTo(m.x - m.vx*m.length*0.02, m.y - m.vy*m.length*0.02);
      ctx.stroke();

      // glow
      ctx.beginPath();
      ctx.fillStyle = 'rgba(255,255,255,' + (1-prog) + ')';
      ctx.arc(m.x, m.y, 2.5*DPR, 0, Math.PI*2);
      ctx.fill();

      if(m.age > m.life) shooting.splice(i,1);
    }

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
  </script>
</body>
</html>
